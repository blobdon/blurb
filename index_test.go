package main

import (
	"fmt"
	"testing"
)

func TestIndex(t *testing.T) {
	index := map[string][]string{}
	db, err := initBolt("/Users/blobdon/blurbdata/test/test.db")
	// db, err := initBolt("/Users/blobdon/blurbdata/blurb.db")
	if err != nil {
		t.Errorf("Error on init bolt db: %s", err)
	}
	defer db.Close()

	iMap, err := newISBN13Map(db)
	if err != nil {
		t.Errorf("Error creating isbn map %s", err)
	}

	for i := range iMap {
		b, err := bookFromBolt(i, db)
		if err != nil {
			t.Error("Error getting bookview from bolt for isbn ", i, err)
		}
		tokens, err := tokenize(b.ReviewText)
		if err != nil {
			t.Errorf("Error tokenizing review text for %s: %s ", i, err)
		}
		// saveTokensToIndex(tokens, i, db)
		for _, tok := range tokens {
			index[tok] = append(index[tok], i)
		}
	}
	err = structToFile(index, "/Users/blobdon/blurbdata/test/index.json")
	if err != nil {
		t.Error("Error saving index to json file:", err)
	}
}

func TestTokenize(t *testing.T) {
	b, err := fileToBook("/Users/blobdon/blurbdata/test/json/9780060731328.json")
	if err != nil {
		t.Fatal("Failed to get test book data from json")
	}
	src := normString(b.ReviewText)
	tok, _ := tokenize(src)
	maxLen := 0
	for _, t := range tok {
		if len(t) > maxLen {
			maxLen = len(t)
			fmt.Println(t)
		}
	}
	fmt.Println("Max token length =", maxLen)
}

func TestNormString(t *testing.T) {
	if normString(`F.ooB'ar"`) != "f oob ar " {
		t.Error("failed to normalise token correctly")
	}
}

// var src = "\n\n\n\nEditorial Reviews\n\nDaniel Kahneman is one of the most original and interesting thinkers of our time. There may be no other person on the planet who better understands how and why we make the choices we make. In this absolutely amazing book, he shares a lifetime's worth of wisdom presented in a manner that is simple and engaging, but nonetheless stunningly profound. This book is a must read for anyone with a curious mind.\nWilliam B. Ogden Distinguished Service Professor o Steven D. Levitt\n"

var src = "\n\n\n\nEditorial Reviews\n\nDaniel Kahneman is one of the most original and interesting thinkers of our time. There may be no other person on the planet who better understands how and why we make the choices we make. In this absolutely amazing book, he shares a lifetime's worth of wisdom presented in a manner that is simple and engaging, but nonetheless stunningly profound. This book is a must read for anyone with a curious mind.\nWilliam B. Ogden Distinguished Service Professor o Steven D. Levitt\n\n\n\nThis book is a tour de force by an intellectual giant; it is readable, wise, and deep. Buy it fast. Read it slowly and repeatedly. It will change the way you think, on the job, about the world, and in your own life.\nUniversity of Chicago Professor of Economics and c Richard Thaler\n\n\n…an astonishingly rich book: lucid, profound, full of intellectual surprises and self-help value. It is consistently entertaining and frequently touching…I overconfidently urge everyone to buy and read it.—The New York Times Book Review\nJim Holt\n\n\nThe mind is a hilariously muddled compromise between incompatible modes of thought in this fascinating treatise by a giant in the field of decision research. Nobel-winning psychologist Kahneman (Attention and Effort) posits a brain governed by two clashing decision-making processes. The largely unconscious System 1, he contends, makes intuitive snap judgments based on emotion, memory, and hard-wired rules of thumb; the painfully conscious System 2 laboriously checks the facts and does the math, but is so \"lazy\" and distractible that it usually defers to System 1. Kahneman uses this scheme to frame a scintillating discussion of his findings in cognitive psychology and behavioral economics, and of the ingenious experiments that tease out the irrational, self-contradictory logics that underlie our choices. We learn why we mistake statistical noise for coherent patterns; why the stock-picking of well-paid investment advisers and the prognostications of pundits are worthless; why businessmen tend to be both absurdly overconfident and unwisely risk-averse; and why memory affects decision making in counterintuitive ways. Kahneman's primer adds to recent challenges to economic orthodoxies about rational actors and efficient markets; more than that, it's a lucid, marvelously readable guide to spotting—and correcting—our biased misunderstandings of the world. Photos. (Nov.)\nPublishers Weekly\n\n\nA tour de force. . . Kahneman's book is a must read for anyone interested in either human behavior or investing. He clearly shows that while we like to think of ourselves as rational in our decision making, the truth is we are subject to many biases. At least being aware of them will give you a better chance of avoiding them, or at least making fewer of them.” —Larry Swedroe, CBS News“Daniel Kahneman demonstrates forcefully in his new book, Thinking, Fast and Slow, how easy it is for humans to swerve away from rationality.” —Christopher Shea, The Washington Post“An outstanding book, distinguished by beauty and clarity of detail, precision of presentation and gentleness of manner. Its truths are open to all those whose System 2 is not completely defunct. I have hardly touched on its richness.” —Galen Strawson, The Guardian“Brilliant . . . It is impossible to exaggerate the importance of Daniel Kahneman's contribution to the understanding of the way we think and choose. He stands among the giants, a weaver of the threads of Charles Darwin, Adam Smith and Sigmund Freud. Arguably the most important psychologist in history, Kahneman has reshaped cognitive psychology, the analysis of rationality and reason, the understanding of risk and the study of happiness and well-being . . . A magisterial work, stunning in its ambition, infused with knowledge, laced with wisdom, informed by modesty and deeply humane. If you can read only one book this year, read this one.” —Janice Gross Stein, The Globe and Mail“A sweeping, compelling tale of just how easily our brains are bamboozled, bringing in both his own research and that of numerous psychologists, economists, and other experts...Kahneman has a remarkable ability to take decades worth of research and distill from it what would be important and interesting for a lay audience...Thinking, Fast and Slow is an immensely important book. Many science books are uneven, with a useful or interesting chapter too often followed by a dull one. Not so here. With rare exceptions, the entire span of this weighty book is fascinating and applicable to day-to-day life. Everyone should read Thinking, Fast and Slow.” —Jesse Singal, Boston Globe“We must be grateful to Kahneman for giving us in this book a joyful understanding of the practical side of our personalities.” —Freeman Dyson, The New York Review of Books“Brilliant . . . It is impossible to exaggerate the importance of Daniel Kahneman's contribution to the understanding of the way we think and choose. He stands among the giants, a weaver of the threads of Charles Darwin, Adam Smith and Sigmund Freud. Arguably the most important psychologist in history, Kahneman has reshaped cognitive psychology, the analysis of rationality and reason, the understanding of risk and the study of happiness and well-being . . . A magisterial work, stunning in its ambition, infused with knowledge, laced with wisdom, informed by modesty and deeply humane. If you can read only one book this year, read this one.” —Janice Gross Stein, The Globe and Mail“It is an astonishingly rich book: lucid, profound, full of intellectual surprises and self-help value. It is consistently entertaining and frequently touching, especially when Kahneman is recounting his collaboration with Tversky . . . So impressive is its vision of flawed human reason that the New York Times columnist David Brooks recently declared that Kahneman and Tversky's work ‘will be remembered hundreds of years from now,' and that it is ‘a crucial pivot point in the way we see ourselves.' They are, Brooks said, ‘like the Lewis and Clark of the mind' . . . By the time I got to the end of Thinking, Fast and Slow, my skeptical frown had long since given way to a grin of intellectual satisfaction. Appraising the book by the peak-end rule, I overconfidently urge everyone to buy and read it. But for those who are merely interested in Kahenman's takeaway on the Malcolm Gladwell question it is this: If you've had 10,000 hours of training in a predictable, rapid-feedback environment—chess, firefighting, anesthesiology—then blink. In all other cases, think.” —The New York Times Book Review“Ask around and you hear pretty much the same thing. 'Kahneman is the most influential psychologist since Sigmund Freud,' says Christopher Chabris, a professor of psychology at Union College, in New York. 'No one else has had such a broad impact on so many fields' . . . It now seems inevitable that Kahneman, who made his reputation by ignoring or defying conventional wisdom, is about to be anointed the intellectual guru of our economically irrational times.” —Evan R. Goldstein, The Chronicle of Higher Education“There have been many good books on human rationality and irrationality, but only one masterpiece. That masterpiece is Daniel Kahneman's Thinking, Fast and Slow . . . This is one of the greatest and most engaging collections of insights into the human mind I have read.” —William Easterly, Financial Times“[Thinking, Fast and Slow] is wonderful, of course. To anyone with the slightest interest in the workings of his own mind, it is so rich and fascinating that any summary would seem absurd.” —Michael Lewis, Vanity Fair“Absorbingly articulate and infinitely intelligent . . . What's most enjoyable and compelling about Thinking, Fast and Slow is that it's so utterly, refreshingly anti-Gladwellian. There is nothing pop about Kahneman's psychology, no formulaic story arc, no beating you over the head with an artificial, buzzword-encrusted Big Idea. It's just the wisdom that comes from five decades of honest, rigorous scientific work, delivered humbly yet brilliantly, in a way that will forever change the way you think about thinking.” —Maria Popova, The Atlantic“I will never think about thinking quite the same. [Thinking, Fast and Slow] is a monumental achievement.” —Roger Lowenstein, Bloomberg/Businessweek“Profound . . . As Copernicus removed the Earth from the centre of the universe and Darwin knocked humans off their biological perch, Mr. Kahneman has shown that we are not the paragons of reason we assume ourselves to be.” —The Economist“[Kahneman's] disarmingly simple experiments have profoundly changed the way that we think about thinking . . . We like to see ourselves as a Promethean species, uniquely endowed with the gift of reason. But Mr. Kahneman's simple experiments reveal a very different mind, stuffed full of habits that, in most situations, lead us astray.” —Jonah Lehrer, The Wall Street Journal“[A] tour de force of psychological insight, research explication and compelling narrative that brings together in one volume the high points of Mr. Kahneman's notable contributions, over five decades, to the study of human judgment, decision-making and choice . . . Thanks to the elegance and force of his ideas, and the robustness of the evidence he offers for them, he has helped us to a new understanding of our divided minds—and our whole selves.” —Christoper F. Chabris, The Wall Street Journal“The ramifications of Kahenman's work are wide, extending into education, business, marketing, politics . . . and even happiness research. Call his field \"psychonomics,\" the hidden reasoning behind our choices. Thinking, Fast and Slow is essential reading for anyone with a mind.” —Kyle Smith, The New York Post“A major intellectual event . . . The work of Kahneman and Tversky was a crucial pivot point in the way we see ourselves.” —David Brooks, The New York Times“Kahneman provides a detailed, yet accessible, description of the psychological mechanisms involved in making decisions.” —Jacek Debiec, Nature“With Kahneman's expert help, readers may understand this mix of psychology and economics better than most accountants, therapists, or elected representatives. VERDICT A stellar accomplishment, a book for everyone who likes to think and wants to do it better.” —Library Journal“The mind is a hilariously muddled compromise between incompatible modes of thought in this fascinating treatise by a giant in the field of decision research. Nobel-winning psychologist Kahneman (Attention and Effort) posits a brain governed by two clashing decision-making processes. The largely unconscious System 1, he contends, makes intuitive snap judgments based on emotion, memory, and hard-wired rules of thumb; the painfully conscious System 2 laboriously checks the facts and does the math, but is so \"lazy\" and distractible that it usually defers to System 1. Kahneman uses this scheme to frame a scintillating discussion of his findings in cognitive psychology and behavioral economics, and of the ingenious experiments that tease out the irrational, self-contradictory logics that underlie our choices. We learn why we mistake statistical noise for coherent patterns; why the stock-picking of well-paid investment advisers and the prognostications of pundits are worthless; why businessmen tend to be both absurdly overconfident and unwisely risk-averse; and why memory affects decision making in counterintuitive ways. Kahneman's primer adds to recent challenges to economic orthodoxies about rational actors and efficient markets; more than that, it's a lucid, marvelously readable guide to spotting—and correcting—our biased misunderstandings of the world.” —Publishers' Weekly (starred review)“For anyone interested in economics, cognitive science, psychology, and, in short, human behavior, this is the book of the year. Before Malcolm Gladwell and Freakonomics, there was Daniel Kahneman who invented the field of behavior economics, won a Nobel…and now explains how we think and make choices. Here's an easy choice: read this.” —The Daily Beast“This book is one of the few that must be counted as mandatory reading for anyone interested in the Internet, even though it doesn't claim to be about that. Before computer networking got cheap and ubiquitous, the sheer inefficiency of communication dampened the effects of the quirks of human psychology on macro scale events. No more. We must now confront how we really are in order to make sense of our world and not screw it up. Daniel Kahneman has discovered a path to make it possible.” —Jaron Lanier, author of You Are Not a Gadget“Daniel Kahneman is one of the most original and interesting thinkers of our time. There may be no other person on the planet who better understands how and why we make the choices we make. In this absolutely amazing book, he shares a lifetime's worth of wisdom presented in a manner that is simple and engaging, but nonetheless stunningly profound. This book is a must read for anyone with a curious mind.” —Steven D. Levitt, William B. Ogden Distinguished Service Professor of Economics at the University of Chicago; co-author of Freakonomics and SuperFreakonomics.“Thinking, Fast and Slow is a masterpiece—a brilliant and engaging intellectual saga by one of the greatest psychologists and deepest thinkers of our time. Kahneman should be parking a Pulitzer next to his Nobel Prize.” —Daniel Gilbert, Harvard University Professor of Psychology, author of Stumbling on Happiness, host of the award-winning PBS television series \"This Emotional Life\"“This book is a tour de force by an intellectual giant; it is readable, wise, and deep. Buy it fast. Read it slowly and repeatedly. It will change the way you think, on the job, about the world, and in your own life.” —Richard Thaler, University of Chicago Professor of Economics and co-author of Nudge“This is a landmark book in social thought, in the same league as The Wealth of Nations by Adam Smith and The Interpretation of Dreams by Sigmund Freud.” —Nassim Taleb, author of The Black Swan“Daniel Kahneman is among the most influential psychologists in history and certainly the most important psychologist alive today. He has a gift for uncovering remarkable features of the human mind, many of which have become textbook classics and part of the conventional wisdom. His work has reshaped social psychology, cognitive science, the study of reason and of happiness, and behavioral economics, a field that he and his collaborator Amos Tversky helped to launch. The appearance of Thinking, Fast and Slow is a major event.” —Steven Pinker, Harvard College Professor of Psychology, Harvard University, and author of How the Mind Works and The Better Angels of our Nature\nFrom the Publisher\n\n\nKahneman (psychology, emeritus, Princeton) won the 2002 Nobel Prize in Economics for his work with Amos Tversky on decision making. In this large, readable book, Kahneman presents provocative theories and groundbreaking research and, moreover, clearly explains both. He postulates two systems of thinking that operate simultaneously but often at odds: intuitive and deliberative, or fast and slow, respectively. Fast judgments dominate to a greater extent than we know and to our disadvantage. A key discovery that overcame an effect Kahneman terms \"theory induced blindness\" (which refers mainly to fast-thinking mistakes but can occur in slow thinking when our assumptions are wrong or simply interfere with seeing) was that outcomes are better defined by gains and losses than by sums of wealth. \"Prospect theory,\" an idea Kahneman developed with Tversky, posits that, when all our options are bad, we tend to take riskier paths. With Kahneman's expert help, readers may understand this mix of psychology and economics better than most accountants, therapists, or elected representatives. VERDICT A stellar accomplishment, a book for everyone who likes to think and wants to do it better. [See Prepub Alert, 5/9/11]—E. James Lieberman, George Washington Univ. Sch. of Medicine, Washington, DC\nLibrary Journal\n\n\nA psychologist and Nobel Prize winner summarizes and synthesizes the recent decades of research on intuition and systematic thinking.The author of several scholarly texts, Kahneman (Emeritus Psychology and Public Affairs/Princeton Univ.) now offers general readers not just the findings of psychological research but also a better understanding of how research questions arise and how scholars systematically frame and answer them. He begins with the distinction between System 1 and System 2 mental operations, the former referring to quick, automatic thought, the latter to more effortful, overt thinking. We rely heavily, writes, on System 1, resorting to the higher-energy System 2 only when we need or want to. Kahneman continually refers to System 2 as \"lazy\": We don't want to think rigorously about something. The author then explores the nuances of our two-system minds, showing how they perform in various situations. Psychological experiments have repeatedly revealed that our intuitions are generally wrong, that our assessments are based on biases and that our System 1 hates doubt and despises ambiguity. Kahneman largely avoids jargon; when he does use some (\"heuristics,\" for example), he argues that such terms really ought to join our everyday vocabulary. He reviews many fundamental concepts in psychology and statistics (regression to the mean, the narrative fallacy, the optimistic bias), showing how they relate to his overall concerns about how we think and why we make the decisions that we do. Some of the later chapters (dealing with risk-taking and statistics and probabilities) are denser than others (some readers may resent such demands on System 2!), but the passages that deal with the economic and political implications of the research are gripping.Striking research showing the immense complexity of ordinary thought and revealing the identities of the gatekeepers in our minds.\nKirkus Reviews\n\n\nRead More\n\n\n\n"
